{"version":3,"sources":["../../../src/components/withSourcePermission/index.jsx"],"names":["React","isEmpty","pick","omit","queryString","hoistNonReactStatics","cachedValue","cachedSubscribe","cachedUnsubscribe","logSubscribeError","parameterNames","Set","getParameters","args","Object","assign","parameters","wrap","Component","getName","props","id","idName","ids","idsName","permission","undefined","options","parts","push","idString","join","stringify","NewComponent","getDerivedStateFromProps","nextProps","prevState","name","targets","constructor","value","setState","error","state","componentDidMount","handleUpdate","handleError","shouldComponentUpdate","nextState","nextPropsKeys","keys","filter","key","has","propsKeys","length","i","componentWillUnmount","render","propertyName"],"mappings":"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","sourcesContent":["// @flow\n\nimport type { List } from 'immutable';\nimport * as React from 'react';\nimport isEmpty from 'lodash/isEmpty';\nimport pick from 'lodash/pick';\nimport omit from 'lodash/omit';\nimport queryString from 'query-string';\nimport hoistNonReactStatics from 'hoist-non-react-statics';\nimport { cachedValue, cachedSubscribe, cachedUnsubscribe } from '../../index';\nimport { logSubscribeError } from '../lib/error-logging';\n\nconst parameterNames = new Set([\n  'sort',\n  'order',\n  'limit',\n  'offset',\n  'filter',\n  'type',\n  'query',\n  'readPermission',\n  'hasChild',\n  'hasParent',\n  'onlineInTeam',\n  'parentEdgeContains',\n  'typesInTree',\n]);\n\nconst getParameters = (...args:Array<Object>):Parameters => pick(Object.assign({}, ...args), [...parameterNames]);\n\ntype Parameters = {\n  sort?:string,\n  order?:string,\n  limit?:number,\n  offset?:number,\n  filter?:string,\n  type?:string,\n  query?:string,\n  typesInTree?: Array<string>,\n  readPermission?:boolean,\n  hasChild?: string,\n  hasParent?: string,\n  onlineInTeam?: string,\n  parentEdgeContains?: string,\n  propertyName?: string,\n  permission?: string,\n  idName?: string,\n  idsName?: string,\n};\n\ntype State = {\n  name?: string,\n  targets?: List<string>,\n};\n\nexport default (parameters: Parameters = {}) => function wrap<Props: Object>(Component: React.AbstractComponent<Props>): React.AbstractComponent<$Diff<Props, { [string]: List<string> }>> {\n  const getName = (props: Props) => {\n    const id = parameters.idName ? props[parameters.idName] : props.id;\n    const ids = parameters.idsName ? props[parameters.idsName] : props.ids;\n    const permission = props.permission || parameters.permission;\n    if ((!props.id && !props.ids) || !permission) {\n      return undefined;\n    }\n    const options = getParameters(parameters, props);\n    const parts = ['p'];\n    if (id) {\n      parts.push(id);\n    } else {\n      for (const idString of ids) {\n        parts.push(idString);\n      }\n    }\n    parts.push(permission);\n    if (isEmpty(options)) {\n      return parts.join('/');\n    }\n    return `${parts.join('/')}?${queryString.stringify(options)}`;\n  };\n\n  class NewComponent extends React.Component<Props, State> {\n    static getDerivedStateFromProps(nextProps: Props, prevState: State) {\n      const name = getName(nextProps);\n      if (name !== prevState.name) {\n        return {\n          name,\n          targets: cachedValue(name),\n        };\n      }\n      return null;\n    }\n\n    constructor(props: Props) {\n      super(props);\n      const name = getName(props);\n      this.state = {\n        name,\n        targets: cachedValue(name),\n      };\n    }\n\n    async componentDidMount() {\n      if (this.state.name) {\n        cachedSubscribe(this.state.name, this.handleUpdate, this.handleError);\n      }\n    }\n\n    shouldComponentUpdate(nextProps:Props, nextState:State) {\n      if (this.state.name !== nextState.name) {\n        const name = this.state.name;\n        if (name) {\n          cachedUnsubscribe(name, this.handleUpdate, this.handleError);\n        }\n        if (nextState.name) {\n          cachedSubscribe(nextState.name, this.handleUpdate, this.handleError);\n        }\n      }\n      if (this.state.targets !== nextState.targets) {\n        return true;\n      }\n      const nextPropsKeys = Object.keys(nextProps).filter((key) => !parameterNames.has(key));\n      const propsKeys = Object.keys(this.props).filter((key) => !parameterNames.has(key));\n      if (nextPropsKeys.length !== propsKeys.length) {\n        return true;\n      }\n      for (let i = 0; i < propsKeys.length; i += 1) {\n        const key = propsKeys[i];\n        if (nextProps[key] !== this.props[key]) {\n          return true;\n        }\n      }\n      return false;\n    }\n\n    async componentWillUnmount() {\n      if (this.state.name) {\n        cachedUnsubscribe(this.state.name, this.handleUpdate, this.handleError);\n      }\n    }\n\n\n    handleUpdate = (value:any) => {\n      this.setState({\n        targets: value,\n      });\n    }\n\n    handleError = (error:Error) => {\n      logSubscribeError(this.state.name, error);\n    }\n    \n    render() {\n      const props = omit(this.props, [...parameterNames]);\n      props[parameters.propertyName || 'targets'] = this.state.targets;\n      return <Component {...props} />;\n    }\n  }\n\n  hoistNonReactStatics(NewComponent, Component);\n\n  return NewComponent;\n};\n"],"file":"index.js"}