{"version":3,"sources":["../../../src/components/withNotifications/index.jsx"],"names":["React","isEmpty","pick","omit","queryString","hoistNonReactStatics","cachedValue","cachedSubscribe","cachedUnsubscribe","parameterNames","Set","getParameters","args","Object","assign","parameters","wrap","Component","getName","props","id","idName","ids","idsName","teamId","teamIdName","hasIds","Array","isArray","length","undefined","nodeIds","join","options","stringify","NewComponent","getDerivedStateFromProps","nextProps","prevState","name","notifications","constructor","value","setState","state","componentDidMount","handleUpdate","shouldComponentUpdate","nextState","nextPropsKeys","keys","filter","key","has","propsKeys","i","componentWillUnmount","render","propertyName"],"mappings":"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","sourcesContent":["// @flow\nimport type { List } from 'immutable';\nimport * as React from 'react';\nimport { isEmpty, pick, omit } from 'lodash';\nimport queryString from 'query-string';\nimport hoistNonReactStatics from 'hoist-non-react-statics';\nimport { cachedValue, cachedSubscribe, cachedUnsubscribe } from '../..';\n\nconst parameterNames = new Set([\n  'limit',\n  'offset',\n  'filterNamed',\n  'query',\n]);\n\nconst getParameters = (...args:Array<Object>):Parameters => pick(Object.assign({}, ...args), [...parameterNames]);\n\ntype Parameters = {\n  limit?: number,\n  offset?: number,\n  filterNamed?: boolean,\n  query?: string,\n  propertyName?: string,\n  idName?: string,\n  teamIdName?: string,\n  idsName?: string,\n};\n\ntype State = {\n  name?: string,\n  notifications?: List<string>\n};\n\nexport default (parameters: Parameters = {}) => function wrap<Props: Object>(Component: React.AbstractComponent<Props>): React.AbstractComponent<$Diff<Props, { [string]: List<string> }>> {\n  const getName = (props: Props) => {\n    const id = parameters.idName ? props[parameters.idName] : props.id;\n    const ids = parameters.idsName ? props[parameters.idsName] : props.ids;\n    const teamId = parameters.teamIdName ? props[parameters.teamIdName] : props.teamId;\n\n    const hasIds = (Array.isArray(ids) && ids.length > 0);\n    if ((!id && !hasIds) || !teamId) {\n      return undefined;\n    }\n    const nodeIds = hasIds ? ids.join('/') : id;\n    const options = getParameters(parameters, props);\n    if (isEmpty(options)) {\n      return `notifications/${teamId}/${nodeIds}`;\n    }\n    return `notifications/${teamId}/${nodeIds}?${queryString.stringify(options)}`;\n  };\n\n  class NewComponent extends React.Component<Props, State> {\n    static getDerivedStateFromProps(nextProps: Props, prevState: State) {\n      const name = getName(nextProps);\n      if (name !== prevState.name) {\n        return {\n          name,\n          notifications: cachedValue(name),\n        };\n      }\n      return null;\n    }\n\n    constructor(props: Props) {\n      super(props);\n      const name = getName(props);\n      this.state = {\n        name,\n        notifications: cachedValue(name),\n      };\n    }\n\n    async componentDidMount() {\n      if (this.state.name) {\n        cachedSubscribe(this.state.name, this.handleUpdate);\n      }\n    }\n\n    shouldComponentUpdate(nextProps:Props, nextState:State) {\n      if (this.state.name !== nextState.name) {\n        const name = this.state.name;\n        if (name) {\n          cachedUnsubscribe(name, this.handleUpdate);\n        }\n        if (nextState.name) {\n          cachedSubscribe(nextState.name, this.handleUpdate);\n        }\n      }\n      if (this.state.notifications !== nextState.notifications) {\n        return true;\n      }\n      const nextPropsKeys = Object.keys(nextProps).filter((key) => !parameterNames.has(key));\n      const propsKeys = Object.keys(this.props).filter((key) => !parameterNames.has(key));\n      if (nextPropsKeys.length !== propsKeys.length) {\n        return true;\n      }\n      for (let i = 0; i < propsKeys.length; i += 1) {\n        const key = propsKeys[i];\n        if (nextProps[key] !== this.props[key]) {\n          return true;\n        }\n      }\n      return false;\n    }\n\n    async componentWillUnmount() {\n      if (this.state.name) {\n        cachedUnsubscribe(this.state.name, this.handleUpdate);\n      }\n    }\n\n\n    handleUpdate = (value:any) => {\n      this.setState({\n        notifications: value,\n      });\n    }\n\n    render() {\n      const props = omit(this.props, [...parameterNames]);\n      props[parameters.propertyName || 'notifications'] = this.state.notifications;\n      return <Component {...props} />;\n    }\n  }\n\n  hoistNonReactStatics(NewComponent, Component);\n\n  return NewComponent;\n};\n"],"file":"index.jsx"}