{"version":3,"sources":["../src/browser-cache.js"],"names":["SubscribeError","braidClient","cachedValue","db","request","self","indexedDB","open","onupgradeneeded","e","insertionsObjectStore","target","result","createObjectStore","keyPath","createIndex","unique","error","name","deletionsObjectStore","onerror","logger","errorStack","onsuccess","event","info","dequeueStorageOperations","getRecentlyUpdatedItems","getReadOnlyInsertionsObjectStore","transaction","objectStore","onabort","console","getReadOnlyDeletionsObjectStore","getReadWriteInsertionsObjectStore","getReadWriteDeletionsObjectStore","queuedInsertions","queuedDeletions","pendingStorageFlush","requestAnimationFrame","_dequeueStorageOperations","length","id","key","shift","put","updated","Date","now","pair","on","insertions","deletions","item","push","processBraidData","data","process","bind","itemKey","warn","insertionTransaction","insertionRequest","delete","deletionTransaction","deletionRequest","queuedSubscriptions","pendingSubscriptionsFlush","dequeueSubscriptions","setImmediate","_dequeueSubscriptions","get","insertionPromise","Promise","resolve","deletionPromise","all","then","updatedKeyRange","IDBKeyRange","lowerBound","insertionsUpdatedIndex","index","insertionsPromise","openCursor","cursor","value","continue","deletionsUpdatedIndex","deletionsPromise"],"mappings":"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","sourcesContent":["// @flow\n\nimport { SubscribeError } from '@bunchtogether/braid-client';\nimport { braidClient, cachedValue } from './index';\n\nlet db;\n\n(() => {\n  const request = self.indexedDB.open('boost-02', 1);\n\n  request.onupgradeneeded = function (e) {\n    try {\n      const insertionsObjectStore = e.target.result.createObjectStore('insertions', { keyPath: 'key' });\n      insertionsObjectStore.createIndex('updated', 'updated', { unique: false });\n    } catch (error) {\n      if (!(error.name === 'ConstraintError')) {\n        throw error;\n      }\n    }\n    try {\n      const deletionsObjectStore = e.target.result.createObjectStore('deletions', { keyPath: 'key' });\n      deletionsObjectStore.createIndex('updated', 'updated', { unique: false });\n    } catch (error) {\n      if (!(error.name === 'ConstraintError')) {\n        throw error;\n      }\n    }\n  };\n\n  request.onerror = (error) => {\n    braidClient.logger.error('Unable to open database');\n    braidClient.logger.errorStack(error);\n  };\n\n  request.onsuccess = function (event) {\n    braidClient.logger.info('Opened cache database');\n    db = event.target.result;\n    dequeueStorageOperations();\n    getRecentlyUpdatedItems();\n  };\n})();\n\nconst getReadOnlyInsertionsObjectStore = () => {\n  if (typeof db === 'undefined') {\n    return null;\n  }\n  const transaction = db.transaction(['insertions'], 'readonly');\n  const objectStore = transaction.objectStore('insertions');\n  transaction.onabort = (event) => {\n    braidClient.logger.error('Read only insertions transaction was aborted');\n    console.error(event); // eslint-disable-line no-console\n  };\n  transaction.onerror = (event) => {\n    braidClient.logger.error('Error in read only insertions transaction');\n    console.error(event); // eslint-disable-line no-console\n  };\n  return objectStore;\n};\n\nconst getReadOnlyDeletionsObjectStore = () => {\n  if (typeof db === 'undefined') {\n    return null;\n  }\n  const transaction = db.transaction(['deletions'], 'readonly');\n  const objectStore = transaction.objectStore('deletions');\n  transaction.onabort = (event) => {\n    braidClient.logger.error('Read only deletions transaction was aborted');\n    console.error(event); // eslint-disable-line no-console\n  };\n  transaction.onerror = (event) => {\n    braidClient.logger.error('Error in read only deletions transaction');\n    console.error(event); // eslint-disable-line no-console\n  };\n  return objectStore;\n};\n\nconst getReadWriteInsertionsObjectStore = () => {\n  if (typeof db === 'undefined') {\n    return null;\n  }\n  const transaction = db.transaction(['insertions'], 'readwrite');\n  const objectStore = transaction.objectStore('insertions');\n  transaction.onabort = (event) => {\n    braidClient.logger.error('Read only insertions transaction was aborted');\n    console.error(event); // eslint-disable-line no-console\n  };\n  transaction.onerror = (event) => {\n    braidClient.logger.error('Error in read only insertions transaction');\n    console.error(event); // eslint-disable-line no-console\n  };\n  return objectStore;\n};\n\nconst getReadWriteDeletionsObjectStore = () => {\n  if (typeof db === 'undefined') {\n    return null;\n  }\n  const transaction = db.transaction(['deletions'], 'readwrite');\n  const objectStore = transaction.objectStore('deletions');\n  transaction.onabort = (event) => {\n    braidClient.logger.error('Read only deletions transaction was aborted');\n    console.error(event); // eslint-disable-line no-console\n  };\n  transaction.onerror = (event) => {\n    braidClient.logger.error('Error in read only deletions transaction');\n    console.error(event); // eslint-disable-line no-console\n  };\n  return objectStore;\n};\n\nconst queuedInsertions = [];\nconst queuedDeletions = [];\n\n\nlet pendingStorageFlush = false;\nconst dequeueStorageOperations = () => {\n  if (pendingStorageFlush) {\n    return;\n  }\n  pendingStorageFlush = true;\n  requestAnimationFrame(() => {\n    pendingStorageFlush = false;\n    _dequeueStorageOperations();\n  });\n};\n\nconst _dequeueStorageOperations = () => { // eslint-disable-line no-underscore-dangle\n  if (queuedDeletions.length > 0) {\n    const deletionsObjectStore = getReadWriteDeletionsObjectStore();\n    if (deletionsObjectStore !== null) {\n      while (queuedDeletions.length > 0) {\n        const [id, key] = queuedDeletions.shift();\n        if (queuedDeletions.length > 0) {\n          deletionsObjectStore.put({ key, id, updated: Date.now() });\n          continue;\n        }\n        // Only add a handler to the last item to accelerate the transaction\n        const request = deletionsObjectStore.put({ key, id, updated: Date.now() });\n        request.onerror = (event) => {\n          braidClient.logger.error(`Unable to put deletion ${key} into indexedDB`);\n          console.error(event); // eslint-disable-line no-console\n        };\n      }\n    }\n  }\n  if (queuedInsertions.length > 0) {\n    const insertionsObjectStore = getReadWriteInsertionsObjectStore();\n    if (insertionsObjectStore !== null) {\n      while (queuedInsertions.length > 0) {\n        const [key, pair] = queuedInsertions.shift();\n        if (queuedInsertions.length > 0) {\n          insertionsObjectStore.put({ key, pair, updated: Date.now() });\n          continue;\n        }\n        // Only add a handler to the last item to accelerate the transaction\n        const request = insertionsObjectStore.put({ key, pair, updated: Date.now() });\n        request.onerror = (event) => {\n          braidClient.logger.error(`Unable to put insertion ${key} into indexedDB`);\n          console.error(event); // eslint-disable-line no-console\n        };\n      }\n    }\n  }\n};\n\nbraidClient.on('process', ([insertions, deletions]) => {\n  for (const item of insertions) {\n    queuedInsertions.push(item);\n  }\n  for (const item of deletions) {\n    queuedDeletions.push(item);\n  }\n  dequeueStorageOperations();\n});\n\nconst processBraidData = braidClient.data.process.bind(braidClient.data);\n\nbraidClient.on('error', (error: Error | SubscribeError) => {\n  if (!(error instanceof SubscribeError)) {\n    return;\n  }\n  const { itemKey } = error;\n  if (typeof itemKey !== 'string') {\n    return;\n  }\n  if (typeof db === 'undefined') {\n    return;\n  }\n  braidClient.logger.warn(`Removing ${itemKey} from indexedDB after subscribe error`);\n  const insertionTransaction = db.transaction(['insertions'], 'readwrite');\n  const insertionsObjectStore = insertionTransaction.objectStore('insertions');\n  const insertionRequest = insertionsObjectStore.delete(itemKey);\n  insertionRequest.onerror = function (event) {\n    braidClient.logger.error(`Unable to remove insertion ${itemKey} from indexedDB`);\n    console.error(event); // eslint-disable-line no-console\n  };\n  const deletionTransaction = db.transaction(['deletions'], 'readwrite');\n  const deletionsObjectStore = deletionTransaction.objectStore('deletions');\n  const deletionRequest = deletionsObjectStore.delete(itemKey);\n  deletionRequest.onerror = function (event) {\n    braidClient.logger.error(`Unable to remove deletion ${itemKey} from indexedDB`);\n    console.error(event); // eslint-disable-line no-console\n  };\n});\n\nconst queuedSubscriptions = [];\n\nlet pendingSubscriptionsFlush = false;\nconst dequeueSubscriptions = () => {\n  if (pendingSubscriptionsFlush) {\n    return;\n  }\n  pendingSubscriptionsFlush = true;\n  setImmediate(() => {\n    pendingSubscriptionsFlush = false;\n    _dequeueSubscriptions();\n  });\n};\n\nconst _dequeueSubscriptions = () => { // eslint-disable-line no-underscore-dangle\n  const insertionsObjectStore = getReadOnlyInsertionsObjectStore();\n  const deletionsObjectStore = getReadOnlyDeletionsObjectStore();\n  if (insertionsObjectStore === null) {\n    return null;\n  }\n  if (deletionsObjectStore === null) {\n    return null;\n  }\n  while (queuedSubscriptions.length > 0) {\n    const key = queuedSubscriptions.shift();\n    const insertionRequest = insertionsObjectStore.get(key);\n    const insertionPromise = new Promise((resolve) => {\n      insertionRequest.onsuccess = function () {\n        const item = insertionRequest.result;\n        if (typeof item !== 'undefined') {\n          resolve([[item.key, item.pair]]);\n        } else {\n          resolve([]);\n        }\n      };\n      insertionRequest.onerror = function (event) {\n        braidClient.logger.error(`Unable to get insertion ${key} from indexedDB`);\n        console.error(event); // eslint-disable-line no-console\n        resolve([]);\n      };\n    });\n    const deletionRequest = deletionsObjectStore.get(key);\n    const deletionPromise = new Promise((resolve) => {\n      deletionRequest.onsuccess = function () {\n        const item = deletionRequest.result;\n        if (typeof item !== 'undefined') {\n          resolve([[item.id, item.key]]);\n        } else {\n          resolve([]);\n        }\n      };\n      deletionRequest.onerror = function (event) {\n        braidClient.logger.error(`Unable to get deletion ${key} from indexedDB`);\n        console.error(event); // eslint-disable-line no-console\n        resolve([]);\n      };\n    });\n    Promise.all([insertionPromise, deletionPromise]).then(processBraidData);\n  }\n  return null;\n};\n\nbraidClient.on('subscribe', (key) => {\n  if (typeof cachedValue(key) !== 'undefined') {\n    return;\n  }\n  queuedSubscriptions.push(key);\n  dequeueSubscriptions();\n});\n\nconst getRecentlyUpdatedItems = () => { // eslint-disable-line no-underscore-dangle\n  const insertionsObjectStore = getReadOnlyInsertionsObjectStore();\n  const deletionsObjectStore = getReadOnlyDeletionsObjectStore();\n  // $FlowFixMe\n  const updatedKeyRange = IDBKeyRange.lowerBound(Date.now() - 1000 * 60 * 60 * 24);\n  if (insertionsObjectStore === null) {\n    return null;\n  }\n  if (deletionsObjectStore === null) {\n    return null;\n  }\n  const insertionsUpdatedIndex = insertionsObjectStore.index('updated');\n  const insertionsPromise = new Promise((resolve) => {\n    const insertions = [];\n    const request = insertionsUpdatedIndex.openCursor(updatedKeyRange);\n    request.onsuccess = (event) => {\n      const cursor = event.target.result;\n      if (cursor) {\n        insertions.push([cursor.value.key, cursor.value.pair]);\n        cursor.continue();\n      } else {\n        resolve(insertions);\n      }\n    };\n    request.onerror = function (event) {\n      braidClient.logger.error('Unable to get insertions within the last day from indexedDB');\n      console.error(event); // eslint-disable-line no-console\n      resolve(insertions);\n    };\n  });\n  const deletionsUpdatedIndex = deletionsObjectStore.index('updated');\n  const deletionsPromise = new Promise((resolve) => {\n    const deletions = [];\n    const request = deletionsUpdatedIndex.openCursor(updatedKeyRange);\n    request.onsuccess = (event) => {\n      const cursor = event.target.result;\n      if (cursor) {\n        deletions.push([cursor.value.id, cursor.value.key]);\n        cursor.continue();\n      } else {\n        resolve(deletions);\n      }\n    };\n    request.onerror = function (event) {\n      braidClient.logger.error('Unable to get deletions within the last day from indexedDB');\n      console.error(event); // eslint-disable-line no-console\n      resolve(deletions);\n    };\n  });\n  Promise.all([insertionsPromise, deletionsPromise]).then(processBraidData);\n  return null;\n};\n\n"],"file":"browser-cache.js"}