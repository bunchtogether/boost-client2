{"version":3,"sources":["../src/browser-cache.js"],"names":["SubscribeError","braidClient","flushIgnorePrefixes","db","insertionIdSet","Set","request","self","indexedDB","open","onupgradeneeded","e","insertionsObjectStore","target","result","createObjectStore","keyPath","createIndex","unique","error","name","onerror","logger","errorStack","onsuccess","event","info","dequeueStorageOperations","requestIdleCallback","clearStaleItems","getReadOnlyInsertionsObjectStore","transaction","durability","objectStore","getReadWriteInsertionsObjectStore","queuedInsertions","pendingStorageFlush","_dequeueStorageOperations","length","updated","Date","now","key","pair","shift","put","console","commit","on","insertions","insertionLoop","item","prefix","startsWith","has","delete","push","processBraidData","data","process","bind","itemKey","warn","insertionTransaction","insertionRequest","dequeueRequested","dequeueSubscriptions","queueMicrotask","_dequeueSubscriptions","queuedSubscriptions","get","add","updatedKeyRange","IDBKeyRange","upperBound","insertionsUpdatedIndex","index","insertionsRequest","getAllKeys","id"],"mappings":"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","sourcesContent":["// @flow\n\nimport { SubscribeError } from '@bunchtogether/braid-client';\nimport { braidClient, flushIgnorePrefixes } from './index';\n\nlet db;\n\nconst insertionIdSet = new Set();\n\n(() => {\n  const request = self.indexedDB.open('boost-03', 1);\n\n  request.onupgradeneeded = function (e) {\n    try {\n      const insertionsObjectStore = e.target.result.createObjectStore('insertions', { keyPath: 'key' });\n      insertionsObjectStore.createIndex('updated', 'updated', { unique: false });\n    } catch (error) {\n      if (!(error.name === 'ConstraintError')) {\n        throw error;\n      }\n    }\n  };\n\n  request.onerror = (error) => {\n    braidClient.logger.error('Unable to open database');\n    braidClient.logger.errorStack(error);\n  };\n\n  request.onsuccess = function (event) {\n    braidClient.logger.info('Opened cache database');\n    db = event.target.result;\n    dequeueStorageOperations();\n    requestIdleCallback(clearStaleItems);\n  };\n})();\n\nconst getReadOnlyInsertionsObjectStore = () => {\n  if (typeof db === 'undefined') {\n    return null;\n  }\n  const transaction = db.transaction(['insertions'], 'readonly', { durability: 'relaxed' });\n  const objectStore = transaction.objectStore('insertions');\n  return objectStore;\n};\n\nconst getReadWriteInsertionsObjectStore = () => {\n  if (typeof db === 'undefined') {\n    return null;\n  }\n  const transaction = db.transaction(['insertions'], 'readwrite', { durability: 'relaxed' });\n  const objectStore = transaction.objectStore('insertions');\n  return objectStore;\n};\n\nconst queuedInsertions = [];\n\nlet pendingStorageFlush = false;\nconst dequeueStorageOperations = () => {\n  if (pendingStorageFlush) {\n    return;\n  }\n  pendingStorageFlush = true;\n  requestIdleCallback(() => {\n    pendingStorageFlush = false;\n    _dequeueStorageOperations();\n  });\n};\n\nconst _dequeueStorageOperations = () => { // eslint-disable-line no-underscore-dangle\n  if (queuedInsertions.length === 0) {\n    return;\n  }\n  const updated = Date.now();\n  const insertionsObjectStore = getReadWriteInsertionsObjectStore();\n  if (insertionsObjectStore !== null) {\n    while (queuedInsertions.length > 0) {\n      const [key, pair] = queuedInsertions.shift();\n      if (queuedInsertions.length > 0) {\n        insertionsObjectStore.put({ key, pair, updated });\n        continue;\n      }\n      // Only add a handler to the last item to accelerate the transaction\n      const request = insertionsObjectStore.put({ key, pair, updated });\n      request.onerror = (event) => {\n        braidClient.logger.error(`Unable to put insertion ${key} into indexedDB`);\n        console.error(event); // eslint-disable-line no-console\n      };\n    }\n    insertionsObjectStore.transaction.commit();\n  }\n};\n\nbraidClient.on('process', ([insertions]) => {\n  insertionLoop: // eslint-disable-line no-restricted-syntax,no-labels\n  for (const item of insertions) {\n    for (const prefix of flushIgnorePrefixes) {\n      if (item[0].startsWith(prefix)) {\n        continue insertionLoop; // eslint-disable-line no-labels\n      }\n    }\n    if (insertionIdSet.has(item[1][0])) {\n      insertionIdSet.delete(item[1][0]);\n      continue;\n    }\n    queuedInsertions.push(item);\n  }\n  dequeueStorageOperations();\n});\n\nconst processBraidData = braidClient.data.process.bind(braidClient.data);\n\nbraidClient.on('error', (error: Error | SubscribeError) => {\n  if (!(error instanceof SubscribeError)) {\n    return;\n  }\n  const { itemKey } = error;\n  if (typeof itemKey !== 'string') {\n    return;\n  }\n  if (typeof db === 'undefined') {\n    return;\n  }\n  braidClient.logger.warn(`Removing ${itemKey} from indexedDB after subscribe error`);\n  const insertionTransaction = db.transaction(['insertions'], 'readwrite', { durability: 'relaxed' });\n  const insertionsObjectStore = insertionTransaction.objectStore('insertions');\n  const insertionRequest = insertionsObjectStore.delete(itemKey);\n  insertionRequest.onerror = function (event) {\n    braidClient.logger.error(`Unable to remove insertion ${itemKey} from indexedDB`);\n    console.error(event); // eslint-disable-line no-console\n  };\n  insertionTransaction.commit();\n});\n\nlet dequeueRequested = false;\nconst dequeueSubscriptions = () => {\n  if (dequeueRequested) {\n    return;\n  }\n  dequeueRequested = true;\n  queueMicrotask(() => {\n    dequeueRequested = false;\n    _dequeueSubscriptions();\n  });\n};\n\nconst queuedSubscriptions = [];\n\nconst _dequeueSubscriptions = () => { // eslint-disable-line no-underscore-dangle\n  const insertionsObjectStore = getReadOnlyInsertionsObjectStore();\n  if (insertionsObjectStore === null) {\n    return null;\n  }\n  while (queuedSubscriptions.length > 0) {\n    const key = queuedSubscriptions.shift();\n    const insertionRequest = insertionsObjectStore.get(key);\n    insertionRequest.onsuccess = function () {\n      const item = insertionRequest.result;\n      if (typeof item !== 'undefined') {\n        if (braidClient.data.has(item.key)) {\n          return;\n        }\n        processBraidData([[[item.key, item.pair]], []]);\n        insertionIdSet.add(item.pair[0]);\n      }\n    };\n    insertionRequest.onerror = function (event) {\n      braidClient.logger.error(`Unable to get insertion ${key} from indexedDB`);\n      console.error(event); // eslint-disable-line no-console\n    };\n  }\n  insertionsObjectStore.transaction.commit();\n  return null;\n};\n\nbraidClient.on('subscribe', (key) => {\n  if (braidClient.data.has(key)) {\n    return;\n  }\n  queuedSubscriptions.push(key);\n  dequeueSubscriptions();\n});\n\nconst clearStaleItems = () => { // eslint-disable-line no-underscore-dangle\n  const insertionsObjectStore = getReadWriteInsertionsObjectStore();\n  // $FlowFixMe\n  const updatedKeyRange = IDBKeyRange.upperBound(Date.now() - 1000 * 60 * 60 * 24 * 7);\n  if (insertionsObjectStore === null) {\n    return;\n  }\n  const insertionsUpdatedIndex = insertionsObjectStore.index('updated');\n  const insertionsRequest = insertionsUpdatedIndex.getAllKeys(updatedKeyRange);\n  insertionsRequest.onsuccess = (event) => {\n    for (const id of event.target.result) {\n      insertionsObjectStore.delete(id);\n    }\n  };\n  insertionsRequest.onerror = function (event) {\n    braidClient.logger.error('Unable to clear stale insertions  from indexedDB');\n    console.error(event); // eslint-disable-line no-console\n  };\n};\n\n"],"file":"browser-cache.js"}