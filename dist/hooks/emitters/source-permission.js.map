{"version":3,"sources":["../../../src/hooks/emitters/source-permission.js"],"names":["isEmpty","pick","queryString","EventEmitter","cachedValue","cachedSubscribe","cachedUnsubscribe","parameterNames","SourcePermissionEmitter","constructor","ids","permission","parameters","value","emit","setParameters","cleanup","parts","push","Array","isArray","id","options","name","join","stringify","handleUpdate","undefined"],"mappings":";;AAEA,OAAOA,OAAP,MAAoB,gBAApB;AACA,OAAOC,IAAP,MAAiB,aAAjB;AACA,OAAOC,WAAP,MAAwB,cAAxB;AACA,OAAOC,YAAP,MAAyB,QAAzB;AACA,SAASC,WAAT,EAAsBC,eAAtB,EAAuCC,iBAAvC,QAAgE,QAAhE;AAEA,MAAMC,cAAc,GAAG,CACrB,MADqB,EAErB,OAFqB,EAGrB,OAHqB,EAIrB,QAJqB,EAKrB,QALqB,EAMrB,MANqB,EAOrB,OAPqB,EAQrB,gBARqB,EASrB,UATqB,EAUrB,WAVqB,EAWrB,oBAXqB,EAYrB,aAZqB,CAAvB;AAeA,eAAe,MAAMC,uBAAN,SAAsCL,YAAtC,CAAmD;AAGhEM,EAAAA,WAAW,CAACC,GAAD,EAA8BC,UAA9B,EAAmDC,UAAmB,GAAG,EAAzE,EAA6E;AACtF;;AADsF;;AAAA,0CAmCxEC,KAAD,IAAe;AAC5B,WAAKC,IAAL,CAAU,OAAV,EAAmBD,KAAnB;AACD,KArCuF;;AAEtF,SAAKE,aAAL,CAAmBL,GAAnB,EAAwBC,UAAxB,EAAoCC,UAApC;AACD;;AAEDG,EAAAA,aAAa,CAACL,GAAD,EAA8BC,UAA9B,EAAmDC,UAAmB,GAAG,EAAzE,EAA6E;AACxF,QAAI,CAACF,GAAD,IAAQ,CAACC,UAAb,EAAyB;AACvB,WAAKK,OAAL;AACA;AACD;;AACD,UAAMC,KAAK,GAAG,CAAC,GAAD,CAAd;;AACA,QAAI,OAAOP,GAAP,KAAe,QAAnB,EAA6B;AAC3BO,MAAAA,KAAK,CAACC,IAAN,CAAWR,GAAX;AACD,KAFD,MAEO,IAAIS,KAAK,CAACC,OAAN,CAAcV,GAAd,CAAJ,EAAwB;AAC7B,WAAK,MAAMW,EAAX,IAAiBX,GAAjB,EAAsB;AACpBO,QAAAA,KAAK,CAACC,IAAN,CAAWG,EAAX;AACD;AACF;;AACDJ,IAAAA,KAAK,CAACC,IAAN,CAAWP,UAAX;AACA,UAAMW,OAAO,GAAGrB,IAAI,CAACW,UAAD,EAAa,CAAC,GAAGL,cAAJ,CAAb,CAApB;AACA,UAAMgB,IAAI,GAAGvB,OAAO,CAACsB,OAAD,CAAP,GAAmBL,KAAK,CAACO,IAAN,CAAW,GAAX,CAAnB,GAAsC,GAAEP,KAAK,CAACO,IAAN,CAAW,GAAX,CAAgB,IAAGtB,WAAW,CAACuB,SAAZ,CAAsBH,OAAtB,CAA+B,EAAvG;;AACA,QAAI,KAAKC,IAAL,KAAcA,IAAlB,EAAwB;AACtB,WAAKP,OAAL;AACD;;AACDX,IAAAA,eAAe,CAACkB,IAAD,EAAO,KAAKG,YAAZ,CAAf;AACA,SAAKH,IAAL,GAAYA,IAAZ;AACD;;AAEQ,MAALV,KAAK,GAAG;AACV,QAAI,CAAC,KAAKU,IAAV,EAAgB;AACd,aAAOI,SAAP;AACD;;AACD,WAAOvB,WAAW,CAAC,KAAKmB,IAAN,CAAlB;AACD;;AAMDP,EAAAA,OAAO,GAAG;AACR,SAAKF,IAAL,CAAU,SAAV;;AACA,QAAI,CAAC,KAAKS,IAAV,EAAgB;AACd;AACD;;AACDjB,IAAAA,iBAAiB,CAAC,KAAKiB,IAAN,EAAY,KAAKG,YAAjB,CAAjB;AACA,WAAO,KAAKH,IAAZ;AACD;;AAjD+D","sourcesContent":["// @flow\n\nimport isEmpty from 'lodash/isEmpty';\nimport pick from 'lodash/pick';\nimport queryString from 'query-string';\nimport EventEmitter from 'events';\nimport { cachedValue, cachedSubscribe, cachedUnsubscribe } from '../../';\n\nconst parameterNames = [\n  'sort',\n  'order',\n  'limit',\n  'offset',\n  'filter',\n  'type',\n  'query',\n  'readPermission',\n  'hasChild',\n  'hasParent',\n  'parentEdgeContains',\n  'typesInTree',\n];\n\nexport default class SourcePermissionEmitter extends EventEmitter {\n  name: string | void;\n\n  constructor(ids?:string | Array<string>, permission?: string, parameters?: Object = {}) {\n    super();\n    this.setParameters(ids, permission, parameters);\n  }\n\n  setParameters(ids?:string | Array<string>, permission?: string, parameters?: Object = {}) {\n    if (!ids || !permission) {\n      this.cleanup();\n      return;\n    }\n    const parts = ['p'];\n    if (typeof ids === 'string') {\n      parts.push(ids);\n    } else if (Array.isArray(ids)) {\n      for (const id of ids) {\n        parts.push(id);\n      }\n    }\n    parts.push(permission);\n    const options = pick(parameters, [...parameterNames]);\n    const name = isEmpty(options) ? parts.join('/') : `${parts.join('/')}?${queryString.stringify(options)}`;\n    if (this.name !== name) {\n      this.cleanup();\n    }\n    cachedSubscribe(name, this.handleUpdate);\n    this.name = name;\n  }\n\n  get value() {\n    if (!this.name) {\n      return undefined;\n    }\n    return cachedValue(this.name);\n  }\n\n  handleUpdate = (value:any) => {\n    this.emit('value', value);\n  }\n\n  cleanup() {\n    this.emit('cleanup');\n    if (!this.name) {\n      return;\n    }\n    cachedUnsubscribe(this.name, this.handleUpdate);\n    delete this.name;\n  }\n}\n"],"file":"source-permission.js"}