{"version":3,"sources":["../src/index.js"],"names":["fromJS","eventChannel","buffers","Client","SubscribeError","EventEmitter","unsubscribeMap","Map","callbackMap","errbackMap","cache","affirmed","metricsEmitter","BoostCatastrophicError","Error","constructor","message","name","flushIgnorePrefixes","Set","braidClient","braidClientOpen","Date","now","on","data","key","value","cached","callbackSet","get","callback","subscribeWithErrorHandler","subscribe","catch","error","errbackSet","eb","code","logger","warn","emit","cachedValue","wrappedCallbacks","wrappedErrbacks","cachedSubscribe","errback","skipInitialCallback","delete","start","receivedInitialValue","webSocket","ws","wrappedCallback","hasError","webSocketWait","set","wrappedErrback","add","unsubscribeInterval","unsubscribeCheck","time","unsubscribe","size","clearInterval","undefined","cachedUnsubscribe","setInterval","getReduxChannel","defaultValue","errorStack","process","env","NODE_ENV","stack","handleValue","handleError","originalStack","split","slice","join","expanding","cachedSnapshot","snapshot","initialCached","confirmedSubscriptions","has","Promise","resolve","reject","removeListener","handleAffirm","k","v","immutableValue","triggerDelete"],"mappings":"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","sourcesContent":["// @flow\n\nimport type { EventChannel } from 'redux-saga';\nimport { fromJS } from 'immutable';\nimport { eventChannel, buffers } from 'redux-saga';\nimport Client, { SubscribeError } from '@bunchtogether/braid-client';\nimport EventEmitter from 'events';\n\nexport { SubscribeError } from '@bunchtogether/braid-client';\n\nconst unsubscribeMap:Map<string, number> = new Map();\nconst callbackMap:Map<string, Set<(any) => void>> = new Map();\nconst errbackMap:Map<string, Set<(Error) => void>> = new Map();\nconst cache = {};\nconst affirmed = {};\n\nexport const metricsEmitter = new EventEmitter();\n\nexport class BoostCatastrophicError extends Error {\n  constructor(message:string) {\n    super(message);\n    this.name = 'BoostCatastrophicError';\n  }\n}\n\n\nexport const flushIgnorePrefixes:Set<string> = new Set();\n\nexport const braidClient = new Client();\n\nlet braidClientOpen = Date.now();\n\nbraidClient.on('open', () => {\n  braidClientOpen = Date.now();\n});\n\nbraidClient.data.on('affirm', (key:string) => {\n  affirmed[key] = true;\n});\n\nbraidClient.data.on('set', (key:string, value:any) => {\n  let cached;\n  if (typeof value !== 'undefined') {\n    cached = fromJS(value);\n  }\n  cache[key] = cached;\n  const callbackSet = callbackMap.get(key);\n  if (!callbackSet) {\n    return;\n  }\n  for (const callback of callbackSet) { // eslint-disable-line no-restricted-syntax\n    callback(cached);\n  }\n});\n\nbraidClient.data.on('delete', (key:string) => {\n  delete cache[key];\n  const callbackSet = callbackMap.get(key);\n  if (!callbackSet) {\n    return;\n  }\n  for (const callback of callbackSet) {\n    callback();\n  }\n});\n\nconst subscribeWithErrorHandler = (key:string) => {\n  braidClient.subscribe(key).catch((error) => {\n    const errbackSet = errbackMap.get(key);\n    if (errbackSet) {\n      for (const eb of errbackSet) {\n        eb(error);\n      }\n    }\n    if (error instanceof SubscribeError) {\n      if (error.code === 403) {\n        braidClient.logger.warn(`User is not authorized to subscribe to ${key}`); // eslint-disable-line no-console\n      } else {\n        braidClient.logger.error(`Server error when subscribing to ${key}`); // eslint-disable-line no-console\n      }\n    } else {\n      braidClient.logger.error(`Error subscribing to ${key}: ${error.message}`); // eslint-disable-line no-console\n    }\n    braidClient.emit('error', error);\n  });\n};\n\nexport const cachedValue = (key?: string) => { // eslint-disable-line consistent-return\n  if (key) {\n    return cache[key];\n  }\n};\n\nconst wrappedCallbacks = new Map();\nconst wrappedErrbacks = new Map();\n\nexport const cachedSubscribe = (key: string, callback: (any) => void, errback?: (Error) => void, skipInitialCallback?: boolean = false) => {\n  unsubscribeMap.delete(key);\n  let callbackSet = callbackMap.get(key);\n  const errbackSet = errbackMap.get(key);\n  const start = Date.now();\n  let receivedInitialValue = false;\n  const webSocket = !!braidClient.ws;\n  const wrappedCallback = (value:any) => {\n    if (!receivedInitialValue && (typeof value !== 'undefined' || affirmed[key] === true)) {\n      receivedInitialValue = true;\n      metricsEmitter.emit('subscribe', key, Date.now() - start, {\n        hasError: false,\n        cached: false,\n        skipInitialCallback,\n        webSocketWait: webSocket ? 0 : braidClientOpen - start,\n      });\n    }\n    return callback(value);\n  };\n  wrappedCallbacks.set(callback, wrappedCallback);\n  const wrappedErrback = typeof errback === 'function' ? ((error:Error) => {\n    if (!receivedInitialValue) {\n      receivedInitialValue = true;\n      metricsEmitter.emit('subscribe', key, Date.now() - start, {\n        hasError: true,\n        cached: false,\n        skipInitialCallback,\n        error: error.message,\n        webSocketWait: webSocket ? 0 : braidClientOpen - start,\n      });\n    }\n    return errback(error);\n  }) : ((error:Error) => {\n    if (!receivedInitialValue) {\n      receivedInitialValue = true;\n      metricsEmitter.emit('subscribe', key, Date.now() - start, {\n        hasError: true,\n        cached: false,\n        skipInitialCallback,\n        error: error.message,\n        webSocketWait: webSocket ? 0 : braidClientOpen - start,\n      });\n    }\n  });\n  wrappedErrbacks.set(errback || callback, wrappedErrback);\n  if (errbackSet) {\n    errbackSet.add(wrappedErrback);\n  } else {\n    errbackMap.set(key, new Set([wrappedErrback]));\n  }\n  if (callbackSet) {\n    callbackSet.add(wrappedCallback);\n  } else {\n    callbackSet = new Set([wrappedCallback]);\n    callbackMap.set(key, callbackSet);\n    subscribeWithErrorHandler(key);\n  }\n  const cached = cache[key];\n  if (typeof cached !== 'undefined' || affirmed[key] === true) {\n    receivedInitialValue = true;\n    metricsEmitter.emit('subscribe', key, Date.now() - start, {\n      hasError: false,\n      cached: true,\n      skipInitialCallback,\n      webSocketWait: 0,\n    });\n  }\n  if (!skipInitialCallback) {\n    callback(cached);\n  }\n};\n\nlet unsubscribeInterval;\n\nconst unsubscribeCheck = () => {\n  const now = Date.now();\n  for (const [key, time] of unsubscribeMap) {\n    if (now - time < 10000) {\n      continue;\n    }\n    unsubscribeMap.delete(key);\n    delete affirmed[key];\n    callbackMap.delete(key);\n    braidClient.unsubscribe(key);\n  }\n  if (unsubscribeMap.size === 0) {\n    clearInterval(unsubscribeInterval);\n    unsubscribeInterval = undefined;\n  }\n};\n\nexport const cachedUnsubscribe = (key:string, callback:(any) => void, errback?: (Error) => void) => {\n  const errbackSet = errbackMap.get(key);\n  if (errbackSet) {\n    const wrappedErrback = wrappedErrbacks.get(errback || callback);\n    if (typeof wrappedErrback !== 'function') {\n      throw new Error(`Wrapped errback does not exist for ${key}`);\n    }\n    errbackSet.delete(wrappedErrback);\n    if (errbackSet.size === 0) {\n      errbackMap.delete(key);\n    }\n  }\n  const callbackSet = callbackMap.get(key);\n  if (!callbackSet) {\n    braidClient.unsubscribe(key);\n    return;\n  }\n  const wrappedCallback = wrappedCallbacks.get(callback);\n  if (typeof wrappedCallback !== 'function') {\n    throw new Error(`Wrapped callback does not exist for ${key}`);\n  }\n  callbackSet.delete(wrappedCallback);\n  if (callbackSet.size === 0) {\n    unsubscribeMap.set(key, Date.now());\n    if (!unsubscribeInterval) {\n      unsubscribeInterval = setInterval(unsubscribeCheck, 5000);\n    }\n  }\n};\n\n\nexport const getReduxChannel = (key: string, defaultValue?: any):EventChannel<any> => {\n  const errorStack = process.env.NODE_ENV !== 'production' ? new Error().stack : undefined;\n  return eventChannel((emit: Function) => {\n    const handleValue = (value: any) => {\n      if (typeof value !== 'undefined') {\n        emit(value);\n      } else if (typeof defaultValue !== 'undefined') {\n        emit(defaultValue);\n      }\n    };\n    const handleError = (error: Error) => {\n      if (process.env.NODE_ENV !== 'production') {\n        if (error instanceof SubscribeError) {\n          const originalStack = error.stack;\n          if (typeof errorStack === 'string') {\n            if (typeof originalStack === 'string') {\n              error.stack = [originalStack.split('\\n')[0], ...errorStack.split('\\n').slice(1)].join('\\n'); // eslint-disable-line no-param-reassign\n            } else {\n              error.stack = [`SubscribeError: Error for ${key}`, ...errorStack.split('\\n').slice(1)].join('\\n'); // eslint-disable-line no-param-reassign\n            }\n            braidClient.logger.errorStack(error);\n          }\n        }\n      }\n      emit(error);\n    };\n    cachedSubscribe(key, handleValue, handleError);\n    return () => {\n      cachedUnsubscribe(key, handleValue, handleError);\n    };\n  }, buffers.expanding(2));\n};\n\nexport const cachedSnapshot = async (key:string, defaultValue?: any) => {\n  const cached = cache[key];\n  if (typeof cached !== 'undefined' || affirmed[key] === true) {\n    metricsEmitter.emit('snapshot', key, 0, {\n      hasError: false,\n      cached: true,\n      webSocketWait: 0,\n    });\n    if (typeof cached === 'undefined') {\n      return defaultValue;\n    }\n    return cached;\n  }\n  return snapshot(key, defaultValue);\n};\n\nexport const snapshot = async (key:string, defaultValue?: any) => {\n  const start = Date.now();\n  const errorStack = process.env.NODE_ENV !== 'production' ? new Error().stack : undefined;\n  let receivedInitialValue = false;\n  const webSocket = !!braidClient.ws;\n  const initialCached = cache[key];\n  if (braidClient.confirmedSubscriptions.has(key) && (typeof initialCached !== 'undefined' || affirmed[key])) {\n    metricsEmitter.emit('snapshot', key, Date.now() - start, {\n      hasError: false,\n      cached: true,\n      webSocketWait: 0,\n    });\n    if (typeof initialCached === 'undefined') {\n      return defaultValue;\n    }\n    return initialCached;\n  }\n  return new Promise((resolve, reject) => {\n    const handleValue = (value:any) => {\n      braidClient.data.removeListener('affirm', handleAffirm);\n      cachedUnsubscribe(key, handleValue, handleError);\n      if (typeof value === 'undefined') {\n        resolve(defaultValue);\n      } else {\n        resolve(value);\n      }\n    };\n    const handleError = (error: Error) => {\n      if (process.env.NODE_ENV !== 'production') {\n        if (error instanceof SubscribeError) {\n          const originalStack = error.stack;\n          if (typeof errorStack === 'string') {\n            if (typeof originalStack === 'string') {\n              error.stack = [originalStack.split('\\n')[0], ...errorStack.split('\\n').slice(1)].join('\\n'); // eslint-disable-line no-param-reassign\n            } else {\n              error.stack = [`SubscribeError: Error for ${key}`, ...errorStack.split('\\n').slice(1)].join('\\n'); // eslint-disable-line no-param-reassign\n            }\n            braidClient.logger.errorStack(error);\n          }\n        }\n      }\n      braidClient.data.removeListener('affirm', handleAffirm);\n      cachedUnsubscribe(key, handleValue, handleError);\n      reject(error);\n    };\n    const handleAffirm = (k:string, v:any) => {\n      if (k !== key) {\n        return;\n      }\n      braidClient.data.removeListener('affirm', handleAffirm);\n      if (!receivedInitialValue) {\n        receivedInitialValue = true;\n        metricsEmitter.emit('snapshot', key, Date.now() - start, {\n          hasError: false,\n          cached: false,\n          webSocketWait: webSocket ? 0 : braidClientOpen - start,\n        });\n      }\n      cachedUnsubscribe(key, handleValue, handleError);\n      const cached = cache[key];\n      if (typeof cached !== 'undefined') {\n        resolve(cached);\n        return;\n      }\n      if (typeof v !== 'undefined') {\n        const immutableValue = fromJS(v);\n        cache[key] = immutableValue;\n        resolve(immutableValue);\n        return;\n      }\n      resolve(defaultValue);\n    };\n    braidClient.data.on('affirm', handleAffirm);\n    unsubscribeMap.delete(key);\n    const wrappedErrback = (error:Error) => {\n      if (!receivedInitialValue) {\n        receivedInitialValue = true;\n        metricsEmitter.emit('snapshot', key, Date.now() - start, {\n          hasError: true,\n          cached: false,\n          error: error.message,\n          webSocketWait: webSocket ? 0 : braidClientOpen - start,\n        });\n      }\n      return handleError(error);\n    };\n    wrappedErrbacks.set(handleError, wrappedErrback);\n    let errbackSet = errbackMap.get(key);\n    if (!errbackSet) {\n      errbackSet = new Set();\n      errbackMap.set(key, errbackSet);\n    }\n    errbackSet.add(wrappedErrback);\n    const wrappedCallback = (value:any) => {\n      if (!receivedInitialValue && (typeof value !== 'undefined' || affirmed[key] === true)) {\n        receivedInitialValue = true;\n        metricsEmitter.emit('snapshot', key, Date.now() - start, {\n          hasError: false,\n          cached: false,\n          webSocketWait: webSocket ? 0 : braidClientOpen - start,\n        });\n      }\n      return handleValue(value);\n    };\n    wrappedCallbacks.set(handleValue, wrappedCallback);\n    let callbackSet = callbackMap.get(key);\n    if (callbackSet) {\n      callbackSet.add(wrappedCallback);\n      return;\n    }\n    callbackSet = new Set([wrappedCallback]);\n    callbackMap.set(key, callbackSet);\n    subscribeWithErrorHandler(key);\n  });\n};\n\nexport const triggerDelete = (key:string) => {\n  braidClient.data.delete(key);\n};\n"],"file":"index.js"}